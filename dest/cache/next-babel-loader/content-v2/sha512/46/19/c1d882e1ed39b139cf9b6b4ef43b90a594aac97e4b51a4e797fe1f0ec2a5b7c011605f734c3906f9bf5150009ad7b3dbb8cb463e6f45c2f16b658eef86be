{"ast":null,"code":"import _Tabs from \"antd/lib/tabs\";\nimport { jsxs as _jsxs } from \"react/jsx-runtime\";\nimport _Button from \"antd/lib/button\";\nimport { jsx as _jsx } from \"react/jsx-runtime\";\nimport _JSXStyle from \"styled-jsx/style\";\n\nconst api = require(\"../lib/api\");\n\nimport { MailOutlined } from \"@ant-design/icons\";\nimport { connect } from \"react-redux\";\nimport getConfig from \"next/config\";\nconst {\n  publicRuntimeConfig\n} = getConfig();\nimport Repo from \"../components/Repo\"; // 存储 tabs 栏的状态,以参数的形式传递下去\n\nimport Router, { withRouter } from \"next/router\";\nimport { useEffect } from \"react\"; // 加入缓存策略\n\nimport LRU from \"lru-cache\";\nimport { setCache } from \"../lib/repo-basic-cache\";\nconst cache = new LRU({\n  // 表示最长的事件不去使用缓存在里面 key 的数据，就会把该数据删除\n  maxAge: 1000 * 60 * 10\n}); // const Index = ({ Component, pageProps, reduxStore }) => {\n//   // console.log(isLogin);\n//   // console.log(userRepos);\n//   // console.log(userStaredRepos);\n//   return <span>去登录</span>;\n// };\n// 用于存储传递过来的数据\n// 注意：这个是在模块的全局作用域里面的，会一直存在的，永远都会有值\n// 所以对于服务端渲染，我们需要做层判断，不应该使用这个全局变量的值\n\nlet userLocalRepos, userLocalStaredRepos;\nlet userFlag;\nconst isServer = true;\n\nfunction Index({\n  userRepos,\n  userStaredRepos,\n  user,\n  router\n}) {\n  const tabKey = router.query.key || \"1\";\n\n  const handelTabChange = activeKey => {\n    Router.push(`/?key=${activeKey}`);\n  }; // 第一进来的时候，如果请求的有数据，就应该把数据缓存起来了\n  // 如果不传递参数，则之后在 mounted 的时候调用一次\n\n\n  useEffect(() => {\n    if (!isServer) {\n      // 防止值为 null 的时候也缓存\n      // if (userRepos) {\n      //   cache.set(\"userRepos\", userRepos);\n      // }\n      // if (userStaredRepos) {\n      //   cache.set(\"userStaredRepos\", userStaredRepos);\n      // }\n      // 这种方法是不管有没有发起请求获取到数据，一到时间就会刷新数据\n      userLocalRepos = userRepos;\n      userLocalStaredRepos = userStaredRepos;\n      setTimeout(() => {\n        userLocalRepos = null;\n        userLocalStaredRepos = null;\n      }, 1000 * 60 * 10);\n    }\n  }, [userRepos, userStaredRepos]);\n\n  if (!user || !user.id) {\n    return /*#__PURE__*/_jsxs(\"div\", {\n      className: \"jsx-3088588873\" + \" \" + \"root\",\n      children: [/*#__PURE__*/_jsx(\"p\", {\n        className: \"jsx-3088588873\",\n        children: \"\\u4EB2\\uFF0C\\u60A8\\u8FD8\\u6CA1\\u6709\\u767B\\u5F55\\u54E6~\"\n      }), /*#__PURE__*/_jsx(_Button, {\n        type: \"primary\",\n        href: publicRuntimeConfig.OAUTH_URL,\n        children: \"\\u70B9\\u51FB\\u767B\\u5F55\"\n      }), /*#__PURE__*/_jsx(_JSXStyle, {\n        id: \"3088588873\",\n        children: [\".root.jsx-3088588873{height:400px;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;-webkit-box-pack:center;-webkit-justify-content:center;-ms-flex-pack:center;justify-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;}\"]\n      })]\n    });\n  }\n\n  useEffect(() => {\n    // 服务端渲染对于这段代码是没有必要去执行的，如果重复执行会导致我们的内存没有意义的使用，这段是跟用户的搜索有关的，跟服务端整体渲染是没有关系的，所以需要屏蔽掉。\n    if (!isServer) {\n      setCache(userRepos);\n      setCache(userStaredRepos);\n    }\n  });\n  return /*#__PURE__*/_jsxs(\"div\", {\n    className: \"jsx-4069790378\" + \" \" + \"root\",\n    children: [/*#__PURE__*/_jsxs(\"div\", {\n      className: \"jsx-4069790378\" + \" \" + \"user-info\",\n      children: [/*#__PURE__*/_jsx(\"img\", {\n        src: user.avatar_url,\n        alt: \"user avatar\",\n        className: \"jsx-4069790378\" + \" \" + \"avatar\"\n      }), /*#__PURE__*/_jsx(\"span\", {\n        className: \"jsx-4069790378\" + \" \" + \"login\",\n        children: user.login || \"--\"\n      }), /*#__PURE__*/_jsx(\"span\", {\n        className: \"jsx-4069790378\" + \" \" + \"name\",\n        children: user.name || \"--\"\n      }), /*#__PURE__*/_jsx(\"span\", {\n        className: \"jsx-4069790378\" + \" \" + \"bio\",\n        children: user.bio || \"--\"\n      }), /*#__PURE__*/_jsxs(\"p\", {\n        className: \"jsx-4069790378\" + \" \" + \"email\",\n        children: [/*#__PURE__*/_jsx(MailOutlined, {\n          style: {\n            marginRight: 10\n          }\n        }), /*#__PURE__*/_jsx(\"a\", {\n          href: `mailto:${user.email}`,\n          className: \"jsx-4069790378\",\n          children: user.email || \"--\"\n        })]\n      })]\n    }), /*#__PURE__*/_jsx(\"div\", {\n      className: \"jsx-4069790378\" + \" \" + \"user-repos\",\n      children: /*#__PURE__*/_jsxs(_Tabs, {\n        activeKey: tabKey,\n        onChange: handelTabChange,\n        animated: false,\n        children: [/*#__PURE__*/_jsx(_Tabs.TabPane, {\n          tab: \"\\u4F60\\u7684\\u4ED3\\u5E93\",\n          children: userRepos.map(repo => /*#__PURE__*/_jsx(Repo, {\n            repo: repo\n          }, repo.id))\n        }, \"1\"), /*#__PURE__*/_jsx(_Tabs.TabPane, {\n          tab: \"\\u4F60\\u5173\\u6CE8\\u7684\\u4ED3\\u5E93\",\n          children: userStaredRepos.map(repo => /*#__PURE__*/_jsx(Repo, {\n            repo: repo\n          }, repo.id))\n        }, \"2\")]\n      })\n    }), /*#__PURE__*/_jsx(_JSXStyle, {\n      id: \"4069790378\",\n      children: [\".root.jsx-4069790378{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:flex-start;-webkit-box-align:flex-start;-ms-flex-align:flex-start;align-items:flex-start;padding:20px 0;}\", \".user-info.jsx-4069790378{width:200px;margin-right:40px;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}\", \".login.jsx-4069790378{font-weight:800;font-size:20px;margin-top:20px;}\", \".name.jsx-4069790378{margin-top:20px;color:#333;}\", \".bio.jsx-4069790378{margin-top:20px;color:#333;}\", \".avatar.jsx-4069790378{width:100%;border-radius:5px;}\", \".user-repos.jsx-4069790378{-webkit-box-flex:1;-webkit-flex-grow:1;-ms-flex-positive:1;flex-grow:1;}\"]\n    })]\n  });\n} // 注意我们在组件中（getInitialProps）中，只会使用到 request ，因为 request 会帮助我们去判断是客户端还是服务端\n// 注意 getInitialProps 会在客户端不同页面跳转的时候使用，同样服务端如果我们访问的是 index 这个页面，也会调用 getInitialProps，在服务端渲染的时候调用的时候，我们的运行环境处于 node.js 环境，而不是浏览器的环境，如果我们在 node.js 的环境下请求就会出现请求的是 http://localhost:3000/ 这样的地址，所以会失败（默认的端口是80）\n// 注意这里是 ctx 而不是 {ctx}\n\n\nIndex.getInitialProps = async ctx => {\n  if (!userFlag || !userFlag.id) {\n    return {};\n  } // if (ctx.response.status == 401) {\n  // return {};\n  // }\n  // console.log(ctx, 3333);\n  // return {};\n  // 报 Error: connect ECONNREFUSED 127.0.0.1:80 的错误\n  // 如果是在浏览器里面发送的，会根据我们提供的路径会自动加上我们当前网站的域名（就是http://localhost:3000/）所以它完整请求路径就是 http://localhost:3000/github/search/repositories?q=react\n  // 如果是在服务端渲染的时候进行执行的话，所以没有浏览器里面的域名的，这个时候请求的路径自动在 axios 里面增加的 http://127.0.0.1（默认80端口）/github/search/repositories?q=react，这个时候就不对了，我们 80 端口没有启动，也不是我们想请求的地址\n  // const result = await axios\n  //   .get(\"/github/search/repositories?q=react\")\n  //   .then((resp) => console.log(resp));\n  // 注意 req 和 res 只有在服务端渲染的时候才会有\n  // 注意一旦登出了，我们需要做个请求的判断\n  // 可以通过 ctx.req 和 ctx.res （node.js 对象，不会存在于浏览器运行环境里面的）来进行判断，但是在符合在服务端可以判断。在客户端进行判断，是没有 ctx 对象的。\n\n\n  if (!isServer) {\n    // if (cache.get(\"userRepos\") && cache.get(\"userStaredRepos\")) {\n    //   return {\n    //     userRepos: cache.get(\"userRepos\"),\n    //     userStaredRepos: cache.get(\"userStaredRepos\"),\n    //   };\n    // }\n    if (userLocalRepos && userLocalStaredRepos) {\n      return {\n        userRepos: userLocalRepos,\n        userStaredRepos: userLocalStaredRepos\n      };\n    }\n  } // 发起请求，列出你所有的创建的仓库\n\n\n  const userRepos = await api.request({\n    url: \"/user/repos\"\n  }, ctx.req, ctx.res); // 被关注的仓库\n\n  const userStaredRepos = await api.request({\n    url: \"/gists/starred\"\n  }, ctx.req, ctx.res);\n  return {\n    isLogin: true,\n    userRepos: userRepos.data,\n    userStaredRepos: userStaredRepos.data\n  };\n}; // 注意在写 withRouter 和 connect 的时候，需要把 withRouter 放在外面\n\n\nexport default withRouter(connect(function mapState(state) {\n  userFlag = state.user;\n  return {\n    user: state.user\n  };\n})(Index));","map":null,"metadata":{},"sourceType":"module"}